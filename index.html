<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ottri Executive Dashboard</title>

  <!-- Preconnect hints for performance -->
  <link rel="preconnect" href="https://docs.google.com" crossorigin />
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />

  <!-- Fonts: Inter (UI) + Lato (Titles) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lato:wght@700;900&display=swap" rel="stylesheet" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Base & Typography */
    html {
      min-height: 100%;
      color-scheme: dark;
      background:
        radial-gradient(1200px 600px at 15% -10%, rgba(76,36,159,0.35) 0%, rgba(76,36,159,0) 45%),
        radial-gradient(1000px 500px at 85% 0%, rgba(217,70,239,0.20) 0%, rgba(217,70,239,0) 50%),
        #030014;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }
    body {
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: #e5e7eb; /* A light gray for better readability */
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    .section-title {
      font-family: "Lato", sans-serif;
      font-weight: 700;
    }

    /* Layout & Utilities */
    .loader {
      border: 4px solid rgba(255, 255, 255, 0.2);
      border-top-color: #9378ff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Two-Column Layout for Sections */
    @media (min-width: 1024px) { /* lg breakpoint */
      #sections-container {
        column-count: 2;
        column-gap: 3rem; /* Equivalent to Tailwind's gap-x-12 */
      }
      #sections-container > section {
        break-inside: avoid;
        -webkit-column-break-inside: avoid;
        page-break-inside: avoid;
        display: inline-block;
        width: 100%;
      }
    }

    /* App Icon Component */
    .app-icon-wrapper {
        display: block;
    }
    .app-icon-link {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-decoration: none;
      color: #d1d5db;
      transition: transform 0.2s ease-in-out, color 0.2s ease-in-out;
      will-change: transform;
    }
    .app-icon-link:hover {
      transform: translateY(-4px);
      color: #ffffff;
    }
    .app-icon-container {
      width: 72px;
      height: 72px;
      background: linear-gradient(145deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
      border-radius: 22.5%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 6px rgba(0,0,0,0.2), inset 0 1px 1px rgba(255,255,255,0.05);
      transition: box-shadow 0.2s ease-in-out;
    }
    .app-icon-link:hover .app-icon-container {
       box-shadow: 0 8px 15px rgba(0,0,0,0.3), inset 0 1px 1px rgba(255,255,255,0.05);
    }
    .app-icon-container img, .app-icon-container svg {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .app-icon-name {
      margin-top: 0.5rem;
      font-size: 0.875rem;
      line-height: 1.25;
      font-weight: 500;
      text-align: center;
      width: 80px;
      height: auto; /* Allow height to adjust */
      min-height: 2.5rem; /* Ensure space for two lines */
      display: flex;
      align-items: flex-start;
      justify-content: center;
      white-space: normal;
      padding-top: 0.125rem;
    }

    .app-icon-container--full-bleed {
      padding: 0;
      background: none;
    }
    .app-icon-container--full-bleed img {
      object-fit: cover;
      border-radius: 22.5%;
    }
  </style>
</head>
<body class="antialiased">

  <!-- Loading Indicator -->
  <div id="loading-indicator" class="fixed inset-0 bg-[#030014] flex items-center justify-center z-50">
    <div class="loader"></div>
  </div>

  <!-- Main Content Container -->
  <div id="content-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 opacity-0 transition-opacity duration-500 pb-16">
    <!-- Header will be injected here -->
    <header id="header-container" class="py-2"></header>
    
    <!-- Sections will be injected here into the column layout -->
    <main id="sections-container" class="pb-8"></main>

    <!-- NEW: Resources section will be injected here -->
    <div id="resources-container"></div>
  </div>
  
  <!-- Error Display -->
  <div id="error-container" class="hidden fixed inset-0 bg-black/70 items-center justify-center p-4 z-50">
      <div class="bg-red-900/50 border border-red-500 rounded-lg p-6 max-w-md text-center">
          <h2 class="text-xl font-bold text-red-300">Error Loading Dashboard</h2>
          <p id="error-message" class="mt-2 text-red-200"></p>
      </div>
  </div>


<script>
document.addEventListener('DOMContentLoaded', () => {
  const CONFIG = {
    SHEET_ID: "13JyMHpkE6oBPVQHtYoIhp6DU0KxU7FQcLKUs7VPZXaU",
    ORDER_TAB_NAME: "Order",
    TITLE_TAB_NAME: "Title",
    RESOURCES_TAB_NAME: "Section - Resources",
  };

  const DOM = {
    loading: document.getElementById('loading-indicator'),
    content: document.getElementById('content-container'),
    header: document.getElementById('header-container'),
    sections: document.getElementById('sections-container'),
    resources: document.getElementById('resources-container'),
    errorContainer: document.getElementById('error-container'),
    errorMessage: document.getElementById('error-message'),
  };

  const showError = (message) => {
    DOM.loading.classList.add('hidden');
    DOM.errorMessage.textContent = message;
    DOM.errorContainer.classList.remove('hidden');
    DOM.errorContainer.classList.add('flex');
  };
  
  const fetchTab = async (tabName) => {
    const url = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(tabName)}`;
    try {
      const response = await fetch(url, { cache: "no-store" });
      if (!response.ok) throw new Error(`Network response was not ok for tab: ${tabName}`);
      
      const text = await response.text();
      const openParen = text.indexOf('(');
      const closeParen = text.lastIndexOf(')');
      if (openParen === -1 || closeParen === -1) throw new Error(`Invalid response format`);
      
      const json = JSON.parse(text.substring(openParen + 1, closeParen));
      if (json.status === 'error') throw new Error(json.errors.map(e => e.detailed_message).join(', '));
      return (json.table.rows || []).map(row => (row.c || []).map(cell => cell?.v ?? null));
    } catch (error) {
      console.error(`Fetch error for tab "${tabName}":`, error);
      throw error;
    }
  };

  const renderHeader = (titleData) => {
    if (!titleData || titleData.length < 1) return;
    const [title, description, logoUrl] = titleData[0] || [];

    const logoHTML = logoUrl 
        ? `<div class="flex justify-center md:justify-start"><img src="${logoUrl}" alt="Ottri Logo" class="h-40 w-40 object-contain" onerror="this.style.display='none'"/></div>` 
        : '<div></div>';
        
    const textHTML = `
      <div class="text-center relative md:-top-2">
        ${title ? `<h1 class="section-title text-3xl font-bold text-white tracking-tight">${title}</h1>` : ''}
        ${description ? `<p class="mt-2 max-w-3xl mx-auto text-base text-gray-400">${description}</p>` : ''}
      </div>`;
      
    DOM.header.innerHTML = `
        <div class="grid grid-cols-1 gap-4 items-center md:hidden">
            ${logoHTML}
            ${textHTML}
        </div>
        <div class="hidden md:grid grid-cols-[1fr_auto_1fr] items-center gap-8">
            ${logoHTML}
            ${textHTML}
            <div></div>
        </div>
    `;
  };

  const renderSection = (sectionName, sectionData) => {
    if (!sectionData || sectionData.length === 0) return;
    
    const apps = sectionData.map(row => {
      if (!row) return null;
      const [name, graphic, link, bgColor, fullBleed, appUri, fallbackUrl] = [row[3], row[4], row[5], row[6], row[7], row[8], row[9]];
      if (name) return { name, graphic, link, bgColor, fullBleed, appUri, fallbackUrl };
      return null;
    }).filter(Boolean);

    if (apps.length === 0) return;

    const sectionEl = document.createElement('section');
    sectionEl.className = "py-4";

    const cleanedTitle = sectionName.replace(/^Section\s*-\s*/i, '').trim();

    let sectionHTML = `<div class="text-left mb-4">
        <h2 class="section-title text-xl font-medium text-gray-300">${cleanedTitle}</h2>
      </div>
      <div class="grid grid-cols-4 sm:grid-cols-6 gap-x-4 gap-y-6">`;
    
    apps.forEach(app => {
        const isFullBleed = ['yes', 'true', '1'].includes(String(app.fullBleed).toLowerCase());
        const iconSrc = app.graphic;
        const iconHTML = iconSrc 
          ? `<img src="${iconSrc}" alt="${app.name} logo" loading="lazy" class="transition-transform duration-200 group-hover:scale-110" onerror="this.style.display='none';"/>`
          : '';
        
        const style = app.bgColor && !isFullBleed ? `style="background-color: ${app.bgColor}"` : '';
        const containerClass = isFullBleed ? 'app-icon-container--full-bleed' : '';
        const content = `<div class="app-icon-container ${containerClass}" ${style}>${iconHTML}</div><span class="app-icon-name">${app.name}</span>`;
        
        if (app.appUri) {
            // CORRECTED LOGIC: Use preventDefault() to stop the default link action.
            const onclickHandler = `event.preventDefault(); window.location.href='${app.appUri}'; ${app.fallbackUrl ? `setTimeout(function() { if(!document.hidden) { window.location.href = '${app.fallbackUrl}'; } }, 2500);` : ''}`.replace(/\s*\n\s*/g, ' ');
            sectionHTML += `<a href="${app.appUri}" onclick="${onclickHandler}" class="app-icon-wrapper app-icon-link group">${content}</a>`;
        } else if (app.link) {
            let correctedLink = app.link;
            if (correctedLink && !correctedLink.startsWith('http')) {
                correctedLink = 'https://' + correctedLink;
            }
            sectionHTML += `<a href="${correctedLink}" target="_blank" rel="noopener noreferrer" class="app-icon-wrapper app-icon-link group">${content}</a>`;
        } else {
            sectionHTML += `<div class="app-icon-wrapper app-icon-link cursor-default">${content}</div>`;
        }
    });
    sectionHTML += `</div>`;
    sectionEl.innerHTML = sectionHTML;
    DOM.sections.appendChild(sectionEl);
  };

  const getFileIcon = (url) => {
    const iconProps = 'class="w-6 h-6 mr-4 flex-shrink-0"'; 
    if (!url) url = ''; 
    if (url.includes('/spreadsheets/')) {
      return `<svg ${iconProps} viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V8L14 2ZM18 20H6V4H13V9H18V20ZM12.9 14.5L15 12.4L16.1 13.5L13.5 16.1L12.4 15L14.5 12.9L12.4 10.8L13.5 9.7L16.1 12.3L17.2 11.2L15 9L12.9 11.1L10.8 9L9.7 10.1L12.3 12.7L9.7 15.3L10.8 16.4L12.9 14.2L15 16.3L16.1 15.2L13.5 12.6L12.9 14.5Z" fill="#34A853"/></svg>`;
    }
    if (url.includes('/document/')) {
      return `<svg ${iconProps} viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V8L14 2ZM18 20H6V4H13V9H18V20ZM16 13H8V11H16V13ZM16 17H8V15H16V17Z" fill="#4285F4"/></svg>`;
    }
    if (url.includes('/presentation/')) {
        return `<svg ${iconProps} viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V8L14 2ZM18 20H6V4H13V9H18V20ZM12 12.5H15.5V16H12V12.5ZM8.5 12.5H11.5V14.25H8.5V12.5Z" fill="#F9AB00"/></svg>`;
    }
    if (url.toLowerCase().endsWith('.pdf')) {
      return `<svg ${iconProps} viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V8L14 2ZM18 20H6V4H13V9H18V20ZM9.5 14.5H11.5V13H8V18H9.5V14.5ZM12.5 18H14.5C15.35 18 16 17.35 16 16.5V14C16 13.15 15.35 12.5 14.5 12.5H12.5V18ZM14 16.5H14.5V14H14V16.5Z" fill="#DB4437"/></svg>`;
    }
    return `<svg ${iconProps} viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V8L14 2ZM18 20H6V4H13V9H18V20Z" fill="#909090"/></svg>`;
  };

  const renderResources = (title, resourcesData) => {
    if (!resourcesData || resourcesData.length === 0) return;
    const resources = resourcesData.map(row => {
      const name = row[1];
      const link = row[2];
      const metaText = row[3];
      if (name && link) return { name, link, metaText };
      return null;
    }).filter(Boolean);

    let html = `
        <div class="text-left mb-4">
            <h2 class="section-title text-xl font-medium text-gray-300">${title}</h2>
        </div>
        <div class="space-y-4">`;
    resources.forEach(doc => {
      html += `
        <a href="${doc.link}" target="_blank" rel="noopener noreferrer" 
           class="flex w-full items-center bg-[rgba(255,255,255,0.05)] backdrop-blur-sm px-5 py-3 rounded-2xl border border-white/10 shadow-lg 
                  hover:border-violet-400/80 hover:bg-[rgba(139,92,246,0.1)] transition-all duration-300 ease-in-out group transform hover:scale-[1.03]">
          <div class="flex items-center min-w-0">
            ${getFileIcon(doc.link)}
            <span class="font-medium text-gray-200 truncate group-hover:text-white transition-colors">${doc.name}</span>
          </div>
          <div class="flex-grow"></div>
          ${doc.metaText ? `<span class="text-sm text-gray-400 ml-4 flex-shrink-0">${doc.metaText}</span>` : ''}
        </a>`;
    });
    html += `</div>`;
    DOM.resources.innerHTML = html;
  };

  const init = async () => {
    try {
      const titleData = await fetchTab(CONFIG.TITLE_TAB_NAME).catch(() => []);
      renderHeader(titleData.slice(1));
      
      const orderData = await fetchTab(CONFIG.ORDER_TAB_NAME);
      const sectionOrder = orderData.slice(1).map(row => row[0]).filter(name => name && !name.startsWith('#'));
      if (sectionOrder.length === 0) throw new Error(`The '${CONFIG.ORDER_TAB_NAME}' tab is empty or all sections are hidden.`);
      
      const sectionPromises = sectionOrder.map(tabName => fetchTab(tabName).catch(() => null));
      const allSectionsData = await Promise.all(sectionPromises);
      
      allSectionsData.forEach((data, index) => {
        if (data) renderSection(sectionOrder[index], data.slice(1));
      });

      try {
        const resourcesData = await fetchTab(CONFIG.RESOURCES_TAB_NAME);
        if (resourcesData.length >= 2) {
          const sectionTitle = resourcesData[1][0] || "Important Resources";
          renderResources(sectionTitle, resourcesData.slice(1));
        }
      } catch (e) {
        console.warn(`Could not load resources section: ${e.message}`);
      }

      DOM.loading.classList.add('hidden');
      DOM.content.classList.add('opacity-100');
    } catch (error) {
      showError(error.message || "An unknown error occurred while loading data.");
    }
  };

  init();
});
</script>

</body>
</html>

